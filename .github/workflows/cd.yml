name: CD - Trigger MLOps Deployment Pipeline
on:
push:
branches: [ "develop", "main" ]
jobs:
trigger-pipeline:
runs-on: ubuntu-latest
needs: [build-component-images, build-bentoml-image] # From ci-build.yml

steps:
  - name: Set Environment-Specific Variables
    id: set_vars
    run: |
      if [[ "${{ github.ref_name }}" == "main" ]]; then
        echo "::set-output name=namespace::prod-models"
        echo "::set-output name=model_stage::Production"
        echo "::set-output name=experiment_name::Production Deployments"
      else
        echo "::set-output name=namespace::staging-models"
        echo "::set-output name=model_stage::Staging"
        echo "::set-output name=experiment_name::Staging Deployments"
      fi

  - name: Trigger Airflow DAG
    # This step would use a cURL command or a dedicated action to
    # make an API call to your on-prem Airflow instance's REST API.
    run: |
      curl -X POST \
        '${{ secrets.AIRFLOW_API_ENDPOINT }}/api/v1/dags/ml_pipeline_dag/dagRuns' \
        -H 'Content-Type: application/json' \
        -H 'Authorization: Basic ${{ secrets.AIRFLOW_API_AUTH }}' \
        --data-raw '{
          "conf": {
            "deployment_namespace": "${{ steps.set_vars.outputs.namespace }}",
            "model_stage": "${{ steps.set_vars.outputs.model_stage }}",
            "bento_image_tag": "${{ github.sha }}"
          }
        }